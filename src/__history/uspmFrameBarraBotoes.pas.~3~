unit uspmFrameBarraBotoes;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ToolWin, Vcl.ComCtrls,
  ZAbstractRODataset, ZAbstractDataset, ZDataset, Vcl.ActnList, Data.DB,
  System.Actions, Vcl.ImgList;

type
  TspmFrameBarraBotoes = class(TFrame)
    tbBarraBotoes: TToolBar;
    imBarraBotoes: TImageList;
    alBarraBotoes: TActionList;
  private
    procedure OnExecutarAcaoClick(Sender: TObject);
  public
    procedure InicializarBarraBotoes;
  end;

implementation

{$R *.dfm}

uses
  uspmDados;

{ TsmpFrameBarraBotoes }

procedure TspmFrameBarraBotoes.InicializarBarraBotoes;
var
  oCloneAplicacoes: TZQuery;
  oIcone: TPicture;
  oStream: TMemoryStream;
  oAcao: TAction;
  oBotao: TToolButton;
begin
  oCloneAplicacoes := TZQuery.Create(nil);
  oIcone := TPicture.Create;
  oStream := TMemoryStream.Create;
  try
    try
      if not dmDados.PegarDados(dmDados.qrCadAplicacoes, oCloneAplicacoes) then
      begin
        Exit;
      end;

      oCloneAplicacoes.First;
      while not oCloneAplicacoes.Eof do
      begin
        oStream.Seek(0, soFromBeginning);
        TBlobField(oCloneAplicacoes.FieldByName('BLICONE')).SaveToStream(oStream);
        oStream.Position := 0;
        oIcone.Icon.LoadFromStream(oStream);

        oAcao := TAction.Create(Self.alBarraBotoes);
        oAcao.Name := 'acExecutavel' + oCloneAplicacoes.FieldByName('CDAPLICACOES').AsString;
        oAcao.ActionList := Self.alBarraBotoes;
        oAcao.Category := 'Aplicacoes';
        oAcao.Hint := oCloneAplicacoes.FieldByName('DEEXECUTAVEL').AsString + ' ' + oCloneAplicacoes.FieldByName('DEPARAMETROS').AsString;
        oAcao.ImageIndex := Self.alBarraBotoes.Images.AddIcon(oIcone.Icon);
        oAcao.OnExecute := OnExecutarAcaoClick;

        oBotao := TToolButton.Create(Self.tbBarraBotoes);
        oBotao.Style := tbsButton;
        oBotao.Parent := Self.tbBarraBotoes;
        oBotao.Name := 'btExecutavel' + oCloneAplicacoes.FieldByName('CDAPLICACOES').AsString;
        oBotao.Action := oAcao;
        oBotao.ImageIndex := oAcao.ImageIndex;
        oBotao.ShowHint := false;

        oCloneAplicacoes.Next;
      end;
    except
      on E: Exception do
      begin
        raise Exception.Create(E.Message);
      end;
    end;
  finally
    FreeAndNil(oCloneAplicacoes)
  end;
end;

end.

